import { __decorate, __metadata, __param } from "tslib";
import { Injectable, InjectionToken, Optional, Inject } from '@angular/core';
import { Subject, BehaviorSubject } from 'rxjs';
import * as i0 from "@angular/core";
export const EDITOR_SETTINGS = new InjectionToken('EDITOR_SETTINGS');
let CodeEditorService = class CodeEditorService {
    constructor(settings) {
        // baseUrl = 'assets/monaco';
        this.baseUrl = 'https://unpkg.com/monaco-editor/min';
        // typingsWorkerUrl = 'assets/workers/typings-worker.js';
        this.typingsWorkerUrl = 'https://unpkg.com/@ngstack/code-editor/workers/typings-worker.js';
        this.typingsLoaded = new Subject();
        this.loaded = new Subject();
        this.loadingTypings = new BehaviorSubject(false);
        const defaults = Object.assign({ baseUrl: this.baseUrl, typingsWorkerUrl: this.typingsWorkerUrl }, settings);
        this.baseUrl = defaults.baseUrl;
        this.typingsWorkerUrl = defaults.typingsWorkerUrl;
    }
    loadTypingsWorker() {
        if (!this.typingsWorker && window.Worker) {
            if (this.typingsWorkerUrl.startsWith('http')) {
                const proxyScript = `importScripts('${this.typingsWorkerUrl}');`;
                const proxy = URL.createObjectURL(new Blob([proxyScript], { type: 'text/javascript' }));
                this.typingsWorker = new Worker(proxy);
            }
            else {
                this.typingsWorker = new Worker(this.typingsWorkerUrl);
            }
            this.typingsWorker.addEventListener('message', e => {
                this.loadingTypings.next(false);
                this.typingsLoaded.next(e.data);
            });
        }
        return this.typingsWorker;
    }
    loadTypings(dependencies) {
        if (dependencies && dependencies.length > 0) {
            const worker = this.loadTypingsWorker();
            if (worker) {
                this.loadingTypings.next(true);
                worker.postMessage({
                    dependencies
                });
            }
        }
    }
    loadEditor() {
        return new Promise((resolve, reject) => {
            const onGotAmdLoader = () => {
                window.require.config({
                    paths: { vs: `${this.baseUrl}/vs` }
                });
                if (this.baseUrl.startsWith('http')) {
                    const proxyScript = `
            self.MonacoEnvironment = {
              baseUrl: "${this.baseUrl}"
            };
            importScripts('${this.baseUrl}/vs/base/worker/workerMain.js');
          `;
                    const proxy = URL.createObjectURL(new Blob([proxyScript], { type: 'text/javascript' }));
                    window['MonacoEnvironment'] = {
                        getWorkerUrl: function () {
                            return proxy;
                        }
                    };
                }
                window.require(['vs/editor/editor.main'], () => {
                    this.loaded.next({ monaco });
                    resolve();
                });
            };
            if (!window.require) {
                const loaderScript = document.createElement('script');
                loaderScript.type = 'text/javascript';
                loaderScript.src = `${this.baseUrl}/vs/loader.js`;
                loaderScript.addEventListener('load', onGotAmdLoader);
                document.body.appendChild(loaderScript);
            }
            else {
                onGotAmdLoader();
            }
        });
    }
};
CodeEditorService.ctorParameters = () => [
    { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [EDITOR_SETTINGS,] }] }
];
CodeEditorService.ɵprov = i0.ɵɵdefineInjectable({ factory: function CodeEditorService_Factory() { return new CodeEditorService(i0.ɵɵinject(EDITOR_SETTINGS, 8)); }, token: CodeEditorService, providedIn: "root" });
CodeEditorService = __decorate([
    Injectable({
        providedIn: 'root'
    }),
    __param(0, Optional()),
    __param(0, Inject(EDITOR_SETTINGS)),
    __metadata("design:paramtypes", [Object])
], CodeEditorService);
export { CodeEditorService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29kZS1lZGl0b3Iuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BuZ3N0YWNrL2NvZGUtZWRpdG9yLyIsInNvdXJjZXMiOlsibGliL3NlcnZpY2VzL2NvZGUtZWRpdG9yLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsY0FBYyxFQUFFLFFBQVEsRUFBRSxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDN0UsT0FBTyxFQUFFLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxNQUFNLENBQUM7O0FBS2hELE1BQU0sQ0FBQyxNQUFNLGVBQWUsR0FBRyxJQUFJLGNBQWMsQ0FDL0MsaUJBQWlCLENBQ2xCLENBQUM7QUFlRixJQUFhLGlCQUFpQixHQUE5QixNQUFhLGlCQUFpQjtJQWU1QixZQUdFLFFBQTRCO1FBakI5Qiw2QkFBNkI7UUFDN0IsWUFBTyxHQUFHLHFDQUFxQyxDQUFDO1FBRWhELHlEQUF5RDtRQUN6RCxxQkFBZ0IsR0FDZCxrRUFBa0UsQ0FBQztRQUVyRSxrQkFBYSxHQUFHLElBQUksT0FBTyxFQUFlLENBQUM7UUFDM0MsV0FBTSxHQUFHLElBQUksT0FBTyxFQUFtQixDQUFDO1FBRXhDLG1CQUFjLEdBQUcsSUFBSSxlQUFlLENBQVUsS0FBSyxDQUFDLENBQUM7UUFTbkQsTUFBTSxRQUFRLG1CQUNaLE9BQU8sRUFBRSxJQUFJLENBQUMsT0FBTyxFQUNyQixnQkFBZ0IsRUFBRSxJQUFJLENBQUMsZ0JBQWdCLElBQ3BDLFFBQVEsQ0FDWixDQUFDO1FBRUYsSUFBSSxDQUFDLE9BQU8sR0FBRyxRQUFRLENBQUMsT0FBTyxDQUFDO1FBQ2hDLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxRQUFRLENBQUMsZ0JBQWdCLENBQUM7SUFDcEQsQ0FBQztJQUVPLGlCQUFpQjtRQUN2QixJQUFJLENBQUMsSUFBSSxDQUFDLGFBQWEsSUFBVSxNQUFPLENBQUMsTUFBTSxFQUFFO1lBQy9DLElBQUksSUFBSSxD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Z0JBQ2xELFlBQVksQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLEVBQUUsY0FBYyxDQUFDLENBQUM7Z0JBQ3RELFFBQVEsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLFlBQVksQ0FBQyxDQUFDO2FBQ3pDO2lCQUFNO2dCQUNMLGNBQWMsRUFBRSxDQUFDO2FBQ2xCO1FBQ0gsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0NBQ0YsQ0FBQTs7NENBdEZJLFFBQVEsWUFDUixNQUFNLFNBQUMsZUFBZTs7O0FBakJkLGlCQUFpQjtJQUg3QixVQUFVLENBQUM7UUFDVixVQUFVLEVBQUUsTUFBTTtLQUNuQixDQUFDO0lBaUJHLFdBQUEsUUFBUSxFQUFFLENBQUE7SUFDVixXQUFBLE1BQU0sQ0FBQyxlQUFlLENBQUMsQ0FBQTs7R0FqQmYsaUJBQWlCLENBc0c3QjtTQXRHWSxpQkFBaUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBJbmplY3Rpb25Ub2tlbiwgT3B0aW9uYWwsIEluamVjdCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgU3ViamVjdCwgQmVoYXZpb3JTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBDb2RlRWRpdG9yU2V0dGluZ3MgfSBmcm9tICcuLi9lZGl0b3Itc2V0dGluZ3MnO1xuXG5kZWNsYXJlIGNvbnN0IG1vbmFjbzogYW55O1xuXG5leHBvcnQgY29uc3QgRURJVE9SX1NFVFRJTkdTID0gbmV3IEluamVjdGlvblRva2VuPENvZGVFZGl0b3JTZXR0aW5ncz4oXG4gICdFRElUT1JfU0VUVElOR1MnXG4pO1xuXG5leHBvcnQgaW50ZXJmYWNlIFR5cGluZ3NJbmZvIHtcbiAgZW50cnlQb2ludHM6IHsgW2tleTogc3RyaW5nXTogc3RyaW5nIH07XG4gIGZpbGVzOiBBcnJheTx7XG4gICAgY29udGVudDogc3RyaW5nO1xuICAgIG5hbWU6IHN0cmluZztcbiAgICB1cmw6IHN0cmluZztcbiAgICBwYXRoOiBzdHJpbmc7XG4gIH0+O1xufVxuXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBDb2RlRWRpdG9yU2VydmljZSB7XG4gIC8vIGJhc2VVcmwgPSAnYXNzZXRzL21vbmFjbyc7XG4gIGJhc2VVcmwgPSAnaHR0cHM6Ly91bnBrZy5jb20vbW9uYWNvLWVkaXRvci9taW4nO1xuXG4gIC8vIHR5cGluZ3NXb3JrZXJVcmwgPSAnYXNzZXRzL3dvcmtlcnMvdHlwaW5ncy13b3JrZXIuanMnO1xuICB0eXBpbmdzV29ya2VyVXJsID1cbiAgICAnaHR0cHM6Ly91bnBrZy5jb20vQG5nc3RhY2svY29kZS1lZGl0b3Ivd29ya2Vycy90eXBpbmdzLXdvcmtlci5qcyc7XG5cbiAgdHlwaW5nc0xvYWRlZCA9IG5ldyBTdWJqZWN0PFR5cGluZ3NJbmZvPigpO1xuICBsb2FkZWQgPSBuZXcgU3ViamVjdDx7IG1vbmFjbzogYW55IH0+KCk7XG5cbiAgbG9hZGluZ1R5cGluZ3MgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PGJvb2xlYW4+KGZhbHNlKTtcblxuICBwcml2YXRlIHR5cGluZ3NXb3JrZXI6IFdvcmtlcjtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBAT3B0aW9uYWwoKVxuICAgIEBJbmplY3QoRURJVE9SX1NFVFRJTkdTKVxuICAgIHNldHRpbmdzOiBDb2RlRWRpdG9yU2V0dGluZ3NcbiAgKSB7XG4gICAgY29uc3QgZGVmYXVsdHMgPSB7XG4gICAgICBiYXNlVXJsOiB0aGlzLmJhc2VVcmwsXG4gICAgICB0eXBpbmdzV29ya2VyVXJsOiB0aGlzLnR5cGluZ3NXb3JrZXJVcmwsXG4gICAgICAuLi5zZXR0aW5nc1xuICAgIH07XG5cbiAgICB0aGlzLmJhc2VVcmwgPSBkZWZhdWx0cy5iYXNlVXJsO1xuICAgIHRoaXMudHlwaW5nc1dvcmtlclVybCA9IGRlZmF1bHRzLnR5cGluZ3NXb3JrZXJVcmw7XG4gIH1cblxuICBwcml2YXRlIGxvYWRUeXBpbmdzV29ya2VyKCk6IFdvcmtlciB7XG4gICAgaWYgKCF0aGlzLnR5cGluZ3NXb3JrZXIgJiYgKDxhbnk+d2luZG93KS5Xb3JrZXIpIHtcbiAgICAgIGlmICh0aGlzLnR5cGluZ3NXb3JrZXJVcmwuc3RhcnRzV2l0aCgnaHR0cCcpKSB7XG4gICAgICAgIGNvbnN0IHByb3h5U2NyaXB0ID0gYGltcG9ydFNjcmlwdHMoJyR7dGhpcy50eXBpbmdzV29ya2VyVXJsfScpO2A7XG4gICAgICAgIGNvbnN0IHByb3h5ID0gVVJMLmNyZWF0ZU9iamVjdFVSTChcbiAgICAgICAgICBuZXcgQmxvYihbcHJveHlTY3JpcHRdLCB7IHR5cGU6ICd0ZXh0L2phdmFzY3JpcHQnIH0pXG4gICAgICAgICk7XG4gICAgICAgIHRoaXMudHlwaW5nc1dvcmtlciA9IG5ldyBXb3JrZXIocHJveHkpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy50eXBpbmdzV29ya2VyID0gbmV3IFdvcmtlcih0aGlzLnR5cGluZ3NXb3JrZXJVcmwpO1xuICAgICAgfVxuICAgICAgdGhpcy50eXBpbmdzV29ya2VyLmFkZEV2ZW50TGlzdGVuZXIoJ21lc3NhZ2UnLCBlID0+IHtcbiAgICAgICAgdGhpcy5sb2FkaW5nVHlwaW5ncy5uZXh0KGZhbHNlKTtcbiAgICAgICAgdGhpcy50eXBpbmdzTG9hZGVkLm5leHQoZS5kYXRhKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy50eXBpbmdzV29ya2VyO1xuICB9XG5cbiAgbG9hZFR5cGluZ3MoZGVwZW5kZW5jaWVzOiBzdHJpbmdbXSkge1xuICAgIGlmIChkZXBlbmRlbmNpZXMgJiYgZGVwZW5kZW5jaWVzLmxlbmd0aCA+IDApIHtcbiAgICAgIGNvbnN0IHdvcmtlciA9IHRoaXMubG9hZFR5cGluZ3NXb3JrZXIoKTtcbiAgICAgIGlmICh3b3JrZXIpIHtcbiAgICAgICAgdGhpcy5sb2FkaW5nVHlwaW5ncy5uZXh0KHRydWUpO1xuICAgICAgICB3b3JrZXIucG9zdE1lc3NhZ2Uoe1xuICAgICAgICAgIGRlcGVuZGVuY2llc1xuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBsb2FkRWRpdG9yKCk6IFByb21pc2U8YW55PiB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGNvbnN0IG9uR290QW1kTG9hZGVyID0gKCkgPT4ge1xuICAgICAgICAoPGFueT53aW5kb3cpLnJlcXVpcmUuY29uZmlnKHtcbiAgICAgICAgICBwYXRoczogeyB2czogYCR7dGhpcy5iYXNlVXJsfS92c2AgfVxuICAgICAgICB9KTtcblxuICAgICAgICBpZiAodGhpcy5iYXNlVXJsLnN0YXJ0c1dpdGgoJ2h0dHAnKSkge1xuICAgICAgICAgIGNvbnN0IHByb3h5U2NyaXB0ID0gYFxuICAgICAgICAgICAgc2VsZi5Nb25hY29FbnZpcm9ubWVudCA9IHtcbiAgICAgICAgICAgICAgYmFzZVVybDogXCIke3RoaXMuYmFzZVVybH1cIlxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIGltcG9ydFNjcmlwdHMoJyR7dGhpcy5iYXNlVXJsfS92cy9iYXNlL3dvcmtlci93b3JrZXJNYWluLmpzJyk7XG4gICAgICAgICAgYDtcbiAgICAgICAgICBjb25zdCBwcm94eSA9IFVSTC5jcmVhdGVPYmplY3RVUkwoXG4gICAgICAgICAgICBuZXcgQmxvYihbcHJveHlTY3JpcHRdLCB7IHR5cGU6ICd0ZXh0L2phdmFzY3JpcHQnIH0pXG4gICAgICAgICAgKTtcbiAgICAgICAgICB3aW5kb3dbJ01vbmFjb0Vudmlyb25tZW50J10gPSB7XG4gICAgICAgICAgICBnZXRXb3JrZXJVcmw6IGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICByZXR1cm4gcHJveHk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfTtcbiAgICAgICAgfVxuXG4gICAgICAgICg8YW55PndpbmRvdykucmVxdWlyZShbJ3ZzL2VkaXRvci9lZGl0b3IubWFpbiddLCAoKSA9PiB7XG4gICAgICAgICAgdGhpcy5sb2FkZWQubmV4dCh7IG1vbmFjbyB9KTtcbiAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgIH0pO1xuICAgICAgfTtcblxuICAgICAgaWYgKCEoPGFueT53aW5kb3cpLnJlcXVpcmUpIHtcbiAgICAgICAgY29uc3QgbG9hZGVyU2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc2NyaXB0Jyk7XG4gICAgICAgIGxvYWRlclNjcmlwdC50eXBlID0gJ3RleHQvamF2YXNjcmlwdCc7XG4gICAgICAgIGxvYWRlclNjcmlwdC5zcmMgPSBgJHt0aGlzLmJhc2VVcmx9L3ZzL2xvYWRlci5qc2A7XG4gICAgICAgIGxvYWRlclNjcmlwdC5hZGRFdmVudExpc3RlbmVyKCdsb2FkJywgb25Hb3RBbWRMb2FkZXIpO1xuICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGxvYWRlclNjcmlwdCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBvbkdvdEFtZExvYWRlcigpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG59XG4iXX0=