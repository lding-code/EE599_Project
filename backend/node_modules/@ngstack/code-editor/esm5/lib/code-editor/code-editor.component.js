import { __assign, __awaiter, __decorate, __generator, __metadata } from "tslib";
import { Component, ChangeDetectionStrategy, ViewEncapsulation, ViewChild, ElementRef, Input, Output, EventEmitter, HostListener, } from '@angular/core';
import { CodeEditorService } from '../services/code-editor.service';
import { TypescriptDefaultsService } from '../services/typescript-defaults.service';
import { JavascriptDefaultsService } from '../services/javascript-defaults.service';
import { JsonDefaultsService } from '../services/json-defaults.service';
var CodeEditorComponent = /** @class */ (function () {
    function CodeEditorComponent(editorService, typescriptDefaults, javascriptDefaults, jsonDefaults) {
        this.editorService = editorService;
        this.typescriptDefaults = typescriptDefaults;
        this.javascriptDefaults = javascriptDefaults;
        this.jsonDefaults = jsonDefaults;
        // private _value = '';
        this.defaultOptions = {
            lineNumbers: true,
            contextmenu: false,
            minimap: {
                enabled: false,
            },
        };
        this.subscriptions = [];
        // @Input()
        // set value(v: string) {
        //   if (v !== this._value) {
        //     this._value = v;
        //     this.setEditorValue(v);
        //     this.valueChanged.emit(v);
        //   }
        // }
        // get value(): string {
        //   return this._value;
        // }
        /**
         * Editor theme. Defaults to `vs`.
         *
         * Allowed values: `vs`, `vs-dark` or `hc-black`.
         * @memberof CodeEditorComponent
         */
        this.theme = 'vs';
        /**
         * Editor options.
         *
         * See https://microsoft.github.io/monaco-editor/api/interfaces/monaco.editor.ieditorconstructionoptions.html for more details.
         *
         * @memberof CodeEditorComponent
         */
        this.options = {};
        /**
         * Toggle readonly state of the editor.
         *
         * @memberof CodeEditorComponent
         */
        this.readOnly = false;
        this.valueChanged = new EventEmitter();
        this.loaded = new EventEmitter();
    }
    CodeEditorComponent.prototype.ngOnInit = function () { };
    CodeEditorComponent.prototype.ngOnDestroy = function () {
        this.subscriptions.forEach(function (subscription) { return subscription.unsubscribe(); });
        this.subscriptions = [];
        if (this._editor) {
            this._editor.dispose();
            this._editor = null;
        }
        if (this._model) {
            this._model.dispose();
            this._model = null;
        }
    };
    CodeEditorComponent.prototype.ngOnChanges = function (changes) {
        if (changes.codeModel && !changes.codeModel.firstChange) {
            this.updateModel(changes.codeModel.currentValue);
        }
        if (changes.readOnly && !changes.readOnly.firstChange) {
            if (this._editor) {
                this._editor.updateOptions({
                    readOnly: changes.readOnly.currentValue,
                });
            }
        }
        if (changes.theme && !changes.theme.firstChange) {
            monaco.editor.setTheme(changes.theme.currentValue);
        }
    };
    CodeEditorComponent.prototype.onResize = function () {
        if (this._editor) {
            this._editor.layout();
        }
    };
    CodeEditorComponent.prototype.ngAfterViewInit = function () {
        return __awaiter(this, void 0, void 0, function () {
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, this.editorService.loadEditor()];
                    case 1:
                        _a.sent();
                        this.setupEditor();
                        this.loaded.emit();
                        return [2 /*return*/];
                }
            });
        });
    };
    CodeEditorComponent.prototype.setupEditor = function () {
        var _this = this;
        var domElement = this.editorContent.nativeElement;
        var settings = __assign({ value: '', language: 'text', uri: 'code' }, this.codeModel);
        this._model = monaco.editor.createModel(settings.value, settings.language, monaco.Uri.file(settings.uri));
        var options = Object.assign({}, this.defaultOptions, this.options, {
            readOnly: this.readOnly,
            theme: this.theme,
            model: this._model,
        });
        this._editor = monaco.editor.create(domElement, options);
        this._model.onDidChangeContent(function (e) {
            var newValue = _this._model.getValue();
            if (_this.codeModel) {
                _this.codeModel.value = newValue;
            }
            _this.valueChanged.emit(newValue);
        });
        this.setupDependencies(this.codeModel);
    };
    CodeEditorComponent.prototype.setupDependencies = function (model) {
        if (!model) {
            return;
        }
        var language = model.language;
        if (language) {
            var lang = language.toLowerCase();
            switch (lang) {
                case 'typescript':
                    if (model.dependencies) {
                        this.editorService.loadTypings(model.dependencies);
                    }
                    break;
                case 'javascript':
                    if (model.dependencies) {
                        this.editorService.loadTypings(model.dependencies);
                    }
                    break;
                case 'json':
                    if (model.schemas) {
                        this.jsonDefaults.addSchemas(model.uri, model.schemas);
                    }
                    break;
                default:
                    break;
            }
        }
    };
    CodeEditorComponent.prototype.setEditorValue = function (value) {
        var _this = this;
        // Fix for value change while dispose in process.
        setTimeout(function () {
            if (_this._model) {
                _this._model.setValue(value);
            }
        });
    };
    CodeEditorComponent.prototype.updateModel = function (model) {
        if (model) {
            this.setEditorValue(model.value);
            if (this._model && typeof monaco !== undefined) {
                monaco.editor.setModelLanguage(this._model, model.language);
            }
            this.setupDependencies(model);
        }
    };
    CodeEditorComponent.ctorParameters = function () { return [
        { type: CodeEditorService },
        { type: TypescriptDefaultsService },
        { type: JavascriptDefaultsService },
        { type: JsonDefaultsService }
    ]; };
    __decorate([
        ViewChild('editor', { static: true }),
        __metadata("design:type", ElementRef)
    ], CodeEditorComponent.prototype, "editorContent", void 0);
    __decorate([
        Input(),
        __metadata("design:type", Object)
    ], CodeEditorComponent.prototype, "codeModel", void 0);
    __decorate([
        Input(),
        __metadata("design:type", Object)
    ], CodeEditorComponent.prototype, "theme", void 0);
    __decorate([
        Input(),
        __metadata("design:type", Object)
    ], CodeEditorComponent.prototype, "options", void 0);
    __decorate([
        Input(),
        __metadata("design:type", Object)
    ], CodeEditorComponent.prototype, "readOnly", void 0);
    __decorate([
        Output(),
        __metadata("design:type", Object)
    ], CodeEditorComponent.prototype, "valueChanged", void 0);
    __decorate([
        Output(),
        __metadata("design:type", Object)
    ], CodeEditorComponent.prototype, "loaded", void 0);
    __decorate([
        HostListener('window:resize'),
        __metadata("design:type", Function),
        __metadata("design:paramtypes", []),
        __metadata("design:returntype", void 0)
    ], CodeEditorComponent.prototype, "onResize", null);
    CodeEditorComponent = __decorate([
        Component({
            selector: 'ngs-code-editor',
            template: "<div id=\"editor\" #editor class=\"monaco-editor editor\"></div>\n",
            changeDetection: ChangeDetectionStrategy.OnPush,
            encapsulation: ViewEncapsulation.None,
            // tslint:disable-next-line
            host: { class: 'ngs-code-editor' },
            styles: [".editor{width:100%;height:inherit;min-height:200px}"]
        }),
        __metadata("design:paramtypes", [CodeEditorService,
            TypescriptDefaultsService,
            JavascriptDefaultsService,
            JsonDefaultsService])
    ], CodeEditorComponent);
    return CodeEditorComponent;
}());
export { CodeEditorComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29kZS1lZGl0b3IuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQG5nc3RhY2svY29kZS1lZGl0b3IvIiwic291cmNlcyI6WyJsaWIvY29kZS1lZGl0b3IvY29kZS1lZGl0b3IuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQ0wsU0FBUyxFQUNULHVCQUF1QixFQUN2QixpQkFBaUIsRUFJakIsU0FBUyxFQUNULFVBQVUsRUFDVixLQUFLLEVBQ0wsTUFBTSxFQUNOLFlBQVksRUFHWixZQUFZLEdBQ2IsTUFBTSxlQUFlLENBQUM7QUFFdkIsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0saUNBQWlDLENBQUM7QUFDcEUsT0FBTyxFQUFFLHlCQUF5QixFQUFFLE1BQU0seUNBQXlDLENBQUM7QUFDcEYsT0FBTyxFQUFFLHlCQUF5QixFQUFFLE1BQU0seUNBQXlDLENBQUM7QUFDcEYsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sbUNBQW1DLENBQUM7QUFjeEU7SUFvRUUsNkJBQ1UsYUFBZ0MsRUFDaEMsa0JBQTZDLEVBQzdDLGtCQUE2QyxFQUM3QyxZQUFpQztRQUhqQyxrQkFBYSxHQUFiLGFBQWEsQ0FBbUI7UUFDaEMsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUEyQjtRQUM3Qyx1QkFBa0IsR0FBbEIsa0JBQWtCLENBQTJCO1FBQzdDLGlCQUFZLEdBQVosWUFBWSxDQUFxQjtRQXBFM0MsdUJBQXVCO1FBRWYsbUJBQWMsR0FBRztZQUN2QixXQUFXLEVBQUUsSUFBSTtZQUNqQixXQUFXLEVBQUUsS0FBSztZQUNsQixPQUFPLEVBQUU7Z0JBQ1AsT0FBTyxFQUFFLEtBQUs7YUFDZjtTQUNGLENBQUM7UUFFTSxrQkFBYSxHQUFtQixFQUFFLENBQUM7UUFRM0MsV0FBVztRQUNYLHlCQUF5QjtRQUN6Qiw2QkFBNkI7UUFDN0IsdUJBQXVCO1FBQ3ZCLDhCQUE4QjtRQUM5QixpQ0FBaUM7UUFDakMsTUFBTTtRQUNOLElB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SSxFQUFFLENBQUM7a0NBQ3ZCLFVBQVU7OERBQUM7SUFHMUI7UUFEQyxLQUFLLEVBQUU7OzBEQUNhO0lBc0JyQjtRQURDLEtBQUssRUFBRTs7c0RBQ0s7SUFVYjtRQURDLEtBQUssRUFBRTs7d0RBQ0s7SUFRYjtRQURDLEtBQUssRUFBRTs7eURBQ1M7SUFHakI7UUFEQyxNQUFNLEVBQUU7OzZEQUNpQztJQUcxQztRQURDLE1BQU0sRUFBRTs7dURBQ21CO0lBNkM1QjtRQURDLFlBQVksQ0FBQyxlQUFlLENBQUM7Ozs7dURBSzdCO0lBbkhVLG1CQUFtQjtRQVQvQixTQUFTLENBQUM7WUFDVCxRQUFRLEVBQUUsaUJBQWlCO1lBQzNCLDhFQUEyQztZQUUzQyxlQUFlLEVBQUUsdUJBQXVCLENBQUMsTUFBTTtZQUMvQyxhQUFhLEVBQUUsaUJBQWlCLENBQUMsSUFBSTtZQUNyQywyQkFBMkI7WUFDM0IsSUFBSSxFQUFFLEVBQUUsS0FBSyxFQUFFLGlCQUFpQixFQUFFOztTQUNuQyxDQUFDO3lDQXNFeUIsaUJBQWlCO1lBQ1oseUJBQXlCO1lBQ3pCLHlCQUF5QjtZQUMvQixtQkFBbUI7T0F4RWhDLG1CQUFtQixDQStNL0I7SUFBRCwwQkFBQztDQUFBLEFBL01ELElBK01DO1NBL01ZLG1CQUFtQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIENvbXBvbmVudCxcbiAgQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3ksXG4gIFZpZXdFbmNhcHN1bGF0aW9uLFxuICBPbkNoYW5nZXMsXG4gIE9uRGVzdHJveSxcbiAgQWZ0ZXJWaWV3SW5pdCxcbiAgVmlld0NoaWxkLFxuICBFbGVtZW50UmVmLFxuICBJbnB1dCxcbiAgT3V0cHV0LFxuICBFdmVudEVtaXR0ZXIsXG4gIFNpbXBsZUNoYW5nZXMsXG4gIE9uSW5pdCxcbiAgSG9zdExpc3RlbmVyLFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgQ29kZUVkaXRvclNlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy9jb2RlLWVkaXRvci5zZXJ2aWNlJztcbmltcG9ydCB7IFR5cGVzY3JpcHREZWZhdWx0c1NlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy90eXBlc2NyaXB0LWRlZmF1bHRzLnNlcnZpY2UnO1xuaW1wb3J0IHsgSmF2YXNjcmlwdERlZmF1bHRzU2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2VzL2phdmFzY3JpcHQtZGVmYXVsdHMuc2VydmljZSc7XG5pbXBvcnQgeyBKc29uRGVmYXVsdHNTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvanNvbi1kZWZhdWx0cy5zZXJ2aWNlJztcbmltcG9ydCB7IENvZGVNb2RlbCB9IGZyb20gJy4uL21vZGVscy9jb2RlLm1vZGVsJztcblxuZGVjbGFyZSBjb25zdCBtb25hY286IGFueTtcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnbmdzLWNvZGUtZWRpdG9yJyxcbiAgdGVtcGxhdGVVcmw6ICcuL2NvZGUtZWRpdG9yLmNvbXBvbmVudC5odG1sJyxcbiAgc3R5bGVVcmxzOiBbJy4vY29kZS1lZGl0b3IuY29tcG9uZW50LmNzcyddLFxuICBjaGFuZ2VEZXRlY3Rpb246IENoYW5nZURldGVjdGlvblN0cmF0ZWd5Lk9uUHVzaCxcbiAgZW5jYXBzdWxhdGlvbjogVmlld0VuY2Fwc3VsYXRpb24uTm9uZSxcbiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lXG4gIGhvc3Q6IHsgY2xhc3M6ICduZ3MtY29kZS1lZGl0b3InIH0sXG59KVxuZXhwb3J0IGNsYXNzIENvZGVFZGl0b3JDb21wb25lbnRcbiAgaW1wbGVtZW50cyBPbkluaXQsIE9uQ2hhbmdlcywgT25EZXN0cm95LCBBZnRlclZpZXdJbml0IHtcbiAgcHJpdmF0ZSBfZWRpdG9yOiBhbnk7XG4gIHByaXZhdGUgX21vZGVsOiBhbnk7XG4gIC8vIHByaXZhdGUgX3ZhbHVlID0gJyc7XG5cbiAgcHJpdmF0ZSBkZWZhdWx0T3B0aW9ucyA9IHtcbiAgICBsaW5lTnVtYmVyczogdHJ1ZSxcbiAgICBjb250ZXh0bWVudTogZmFsc2UsXG4gICAgbWluaW1hcDoge1xuICAgICAgZW5hYmxlZDogZmFsc2UsXG4gICAgfSxcbiAgfTtcblxuICBwcml2YXRlIHN1YnNjcmlwdGlvbnM6IFN1YnNjcmlwdGlvbltdID0gW107XG5cbiAgQFZpZXdDaGlsZCgnZWRpdG9yJywgeyBzdGF0aWM6IHRydWUgfSlcbiAgZWRpdG9yQ29udGVudDogRWxlbWVudFJlZjtcblxuICBASW5wdXQoKVxuICBjb2RlTW9kZWw6IENvZGVNb2RlbDtcblxuICAvLyBASW5wdXQoKVxuICAvLyBzZXQgdmFsdWUodjogc3RyaW5nKSB7XG4gIC8vICAgaWYgKHYgIT09IHRoaXMuX3ZhbHVlKSB7XG4gIC8vICAgICB0aGlzLl92YWx1ZSA9IHY7XG4gIC8vICAgICB0aGlzLnNldEVkaXRvclZhbHVlKHYpO1xuICAvLyAgICAgdGhpcy52YWx1ZUNoYW5nZWQuZW1pdCh2KTtcbiAgLy8gICB9XG4gIC8vIH1cblxuICAvLyBnZXQgdmFsdWUoKTogc3RyaW5nIHtcbiAgLy8gICByZXR1cm4gdGhpcy5fdmFsdWU7XG4gIC8vIH1cblxuICAvKipcbiAgICogRWRpdG9yIHRoZW1lLiBEZWZhdWx0cyB0byBgdnNgLlxuICAgKlxuICAgKiBBbGxvd2VkIHZhbHVlczogYHZzYCwgYHZzLWRhcmtgIG9yIGBoYy1ibGFja2AuXG4gICAqIEBtZW1iZXJvZiBDb2RlRWRpdG9yQ29tcG9uZW50XG4gICAqL1xuICBASW5wdXQoKVxuICB0aGVtZSA9ICd2cyc7XG5cbiAgLyoqXG4gICAqIEVkaXRvciBvcHRpb25zLlxuICAgKlxuICAgKiBTZWUgaHR0cHM6Ly9taWNyb3NvZnQuZ2l0aHViLmlvL21vbmFjby1lZGl0b3IvYXBpL2ludGVyZmFjZXMvbW9uYWNvLmVkaXRvci5pZWRpdG9yY29uc3RydWN0aW9ub3B0aW9ucy5odG1sIGZvciBtb3JlIGRldGFpbHMuXG4gICAqXG4gICAqIEBtZW1iZXJvZiBDb2RlRWRpdG9yQ29tcG9uZW50XG4gICAqL1xuICBASW5wdXQoKVxuICBvcHRpb25zID0ge307XG5cbiAgLyoqXG4gICAqIFRvZ2dsZSByZWFkb25seSBzdGF0ZSBvZiB0aGUgZWRpdG9yLlxuICAgKlxuICAgKiBAbWVtYmVyb2YgQ29kZUVkaXRvckNvbXBvbmVudFxuICAgKi9cbiAgQElucHV0KClcbiAgcmVhZE9ubHkgPSBmYWxzZTtcblxuICBAT3V0cHV0KClcbiAgdmFsdWVDaGFuZ2VkID0gbmV3IEV2ZW50RW1pdHRlcjxzdHJpbmc+KCk7XG5cbiAgQE91dHB1dCgpXG4gIGxvYWRlZCA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGVkaXRvclNlcnZpY2U6IENvZGVFZGl0b3JTZXJ2aWNlLFxuICAgIHByaXZhdGUgdHlwZXNjcmlwdERlZmF1bHRzOiBUeXBlc2NyaXB0RGVmYXVsdHNTZXJ2aWNlLFxuICAgIHByaXZhdGUgamF2YXNjcmlwdERlZmF1bHRzOiBKYXZhc2NyaXB0RGVmYXVsdHNTZXJ2aWNlLFxuICAgIHByaXZhdGUganNvbkRlZmF1bHRzOiBKc29uRGVmYXVsdHNTZXJ2aWNlXG4gICkge31cblxuICBuZ09uSW5pdCgpIHt9XG5cbiAgbmdPbkRlc3Ryb3koKSB7XG4gICAgdGhpcy5zdWJzY3JpcHRpb25zLmZvckVhY2goKHN1YnNjcmlwdGlvbikgPT4gc3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCkpO1xuICAgIHRoaXMuc3Vic2NyaXB0aW9ucyA9IFtdO1xuXG4gICAgaWYgKHRoaXMuX2VkaXRvcikge1xuICAgICAgdGhpcy5fZWRpdG9yLmRpc3Bvc2UoKTtcbiAgICAgIHRoaXMuX2VkaXRvciA9IG51bGw7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuX21vZGVsKSB7XG4gICAgICB0aGlzLl9tb2RlbC5kaXNwb3NlKCk7XG4gICAgICB0aGlzLl9tb2RlbCA9IG51bGw7XG4gICAgfVxuICB9XG5cbiAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcykge1xuICAgIGlmIChjaGFuZ2VzLmNvZGVNb2RlbCAmJiAhY2hhbmdlcy5jb2RlTW9kZWwuZmlyc3RDaGFuZ2UpIHtcbiAgICAgIHRoaXMudXBkYXRlTW9kZWwoY2hhbmdlcy5jb2RlTW9kZWwuY3VycmVudFZhbHVlKTtcbiAgICB9XG5cbiAgICBpZiAoY2hhbmdlcy5yZWFkT25seSAmJiAhY2hhbmdlcy5yZWFkT25seS5maXJzdENoYW5nZSkge1xuICAgICAgaWYgKHRoaXMuX2VkaXRvcikge1xuICAgICAgICB0aGlzLl9lZGl0b3IudXBkYXRlT3B0aW9ucyh7XG4gICAgICAgICAgcmVhZE9ubHk6IGNoYW5nZXMucmVhZE9ubHkuY3VycmVudFZhbHVlLFxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoY2hhbmdlcy50aGVtZSAmJiAhY2hhbmdlcy50aGVtZS5maXJzdENoYW5nZSkge1xuICAgICAgbW9uYWNvLmVkaXRvci5zZXRUaGVtZShjaGFuZ2VzLnRoZW1lLmN1cnJlbnRWYWx1ZSk7XG4gICAgfVxuICB9XG5cbiAgQEhvc3RMaXN0ZW5lcignd2luZG93OnJlc2l6ZScpXG4gIG9uUmVzaXplKCkge1xuICAgIGlmICh0aGlzLl9lZGl0b3IpIHtcbiAgICAgIHRoaXMuX2VkaXRvci5sYXlvdXQoKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBuZ0FmdGVyVmlld0luaXQoKSB7XG4gICAgYXdhaXQgdGhpcy5lZGl0b3JTZXJ2aWNlLmxvYWRFZGl0b3IoKTtcbiAgICB0aGlzLnNldHVwRWRpdG9yKCk7XG4gICAgdGhpcy5sb2FkZWQuZW1pdCgpO1xuICB9XG5cbiAgcHJpdmF0ZSBzZXR1cEVkaXRvcigpIHtcbiAgICBjb25zdCBkb21FbGVtZW50OiBIVE1MRGl2RWxlbWVudCA9IHRoaXMuZWRpdG9yQ29udGVudC5uYXRpdmVFbGVtZW50O1xuICAgIGNvbnN0IHNldHRpbmdzID0ge1xuICAgICAgdmFsdWU6ICcnLFxuICAgICAgbGFuZ3VhZ2U6ICd0ZXh0JyxcbiAgICAgIHVyaTogJ2NvZGUnLFxuICAgICAgLi4udGhpcy5jb2RlTW9kZWwsXG4gICAgfTtcblxuICAgIHRoaXMuX21vZGVsID0gbW9uYWNvLmVkaXRvci5jcmVhdGVNb2RlbChcbiAgICAgIHNldHRpbmdzLnZhbHVlLFxuICAgICAgc2V0dGluZ3MubGFuZ3VhZ2UsXG4gICAgICBtb25hY28uVXJpLmZpbGUoc2V0dGluZ3MudXJpKVxuICAgICk7XG5cbiAgICBjb25zdCBvcHRpb25zID0gT2JqZWN0LmFzc2lnbih7fSwgdGhpcy5kZWZhdWx0T3B0aW9ucywgdGhpcy5vcHRpb25zLCB7XG4gICAgICByZWFkT25seTogdGhpcy5yZWFkT25seSxcbiAgICAgIHRoZW1lOiB0aGlzLnRoZW1lLFxuICAgICAgbW9kZWw6IHRoaXMuX21vZGVsLFxuICAgIH0pO1xuXG4gICAgdGhpcy5fZWRpdG9yID0gbW9uYWNvLmVkaXRvci5jcmVhdGUoZG9tRWxlbWVudCwgb3B0aW9ucyk7XG5cbiAgICB0aGlzLl9tb2RlbC5vbkRpZENoYW5nZUNvbnRlbnQoKGUpID0+IHtcbiAgICAgIGNvbnN0IG5ld1ZhbHVlID0gdGhpcy5fbW9kZWwuZ2V0VmFsdWUoKTtcbiAgICAgIGlmICh0aGlzLmNvZGVNb2RlbCkge1xuICAgICAgICB0aGlzLmNvZGVNb2RlbC52YWx1ZSA9IG5ld1ZhbHVlO1xuICAgICAgfVxuICAgICAgdGhpcy52YWx1ZUNoYW5nZWQuZW1pdChuZXdWYWx1ZSk7XG4gICAgfSk7XG5cbiAgICB0aGlzLnNldHVwRGVwZW5kZW5jaWVzKHRoaXMuY29kZU1vZGVsKTtcbiAgfVxuXG4gIHByaXZhdGUgc2V0dXBEZXBlbmRlbmNpZXMobW9kZWw6IENvZGVNb2RlbCkge1xuICAgIGlmICghbW9kZWwpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCB7IGxhbmd1YWdlIH0gPSBtb2RlbDtcblxuICAgIGlmIChsYW5ndWFnZSkge1xuICAgICAgY29uc3QgbGFuZyA9IGxhbmd1YWdlLnRvTG93ZXJDYXNlKCk7XG5cbiAgICAgIHN3aXRjaCAobGFuZykge1xuICAgICAgICBjYXNlICd0eXBlc2NyaXB0JzpcbiAgICAgICAgICBpZiAobW9kZWwuZGVwZW5kZW5jaWVzKSB7XG4gICAgICAgICAgICB0aGlzLmVkaXRvclNlcnZpY2UubG9hZFR5cGluZ3MobW9kZWwuZGVwZW5kZW5jaWVzKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgJ2phdmFzY3JpcHQnOlxuICAgICAgICAgIGlmIChtb2RlbC5kZXBlbmRlbmNpZXMpIHtcbiAgICAgICAgICAgIHRoaXMuZWRpdG9yU2VydmljZS5sb2FkVHlwaW5ncyhtb2RlbC5kZXBlbmRlbmNpZXMpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSAnanNvbic6XG4gICAgICAgICAgaWYgKG1vZGVsLnNjaGVtYXMpIHtcbiAgICAgICAgICAgIHRoaXMuanNvbkRlZmF1bHRzLmFkZFNjaGVtYXMobW9kZWwudXJpLCBtb2RlbC5zY2hlbWFzKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBzZXRFZGl0b3JWYWx1ZSh2YWx1ZTogYW55KTogdm9pZCB7XG4gICAgLy8gRml4IGZvciB2YWx1ZSBjaGFuZ2Ugd2hpbGUgZGlzcG9zZSBpbiBwcm9jZXNzLlxuICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgaWYgKHRoaXMuX21vZGVsKSB7XG4gICAgICAgIHRoaXMuX21vZGVsLnNldFZhbHVlKHZhbHVlKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgdXBkYXRlTW9kZWwobW9kZWw6IENvZGVNb2RlbCkge1xuICAgIGlmIChtb2RlbCkge1xuICAgICAgdGhpcy5zZXRFZGl0b3JWYWx1ZShtb2RlbC52YWx1ZSk7XG4gICAgICBpZiAodGhpcy5fbW9kZWwgJiYgdHlwZW9mIG1vbmFjbyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIG1vbmFjby5lZGl0b3Iuc2V0TW9kZWxMYW5ndWFnZSh0aGlzLl9tb2RlbCwgbW9kZWwubGFuZ3VhZ2UpO1xuICAgICAgfVxuICAgICAgdGhpcy5zZXR1cERlcGVuZGVuY2llcyhtb2RlbCk7XG4gICAgfVxuICB9XG59XG4iXX0=