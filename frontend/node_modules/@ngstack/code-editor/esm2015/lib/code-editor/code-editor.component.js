import { __awaiter, __decorate, __metadata } from "tslib";
import { Component, ChangeDetectionStrategy, ViewEncapsulation, ViewChild, ElementRef, Input, Output, EventEmitter, HostListener, } from '@angular/core';
import { CodeEditorService } from '../services/code-editor.service';
import { TypescriptDefaultsService } from '../services/typescript-defaults.service';
import { JavascriptDefaultsService } from '../services/javascript-defaults.service';
import { JsonDefaultsService } from '../services/json-defaults.service';
let CodeEditorComponent = class CodeEditorComponent {
    constructor(editorService, typescriptDefaults, javascriptDefaults, jsonDefaults) {
        this.editorService = editorService;
        this.typescriptDefaults = typescriptDefaults;
        this.javascriptDefaults = javascriptDefaults;
        this.jsonDefaults = jsonDefaults;
        // private _value = '';
        this.defaultOptions = {
            lineNumbers: true,
            contextmenu: false,
            minimap: {
                enabled: false,
            },
        };
        this.subscriptions = [];
        // @Input()
        // set value(v: string) {
        //   if (v !== this._value) {
        //     this._value = v;
        //     this.setEditorValue(v);
        //     this.valueChanged.emit(v);
        //   }
        // }
        // get value(): string {
        //   return this._value;
        // }
        /**
         * Editor theme. Defaults to `vs`.
         *
         * Allowed values: `vs`, `vs-dark` or `hc-black`.
         * @memberof CodeEditorComponent
         */
        this.theme = 'vs';
        /**
         * Editor options.
         *
         * See https://microsoft.github.io/monaco-editor/api/interfaces/monaco.editor.ieditorconstructionoptions.html for more details.
         *
         * @memberof CodeEditorComponent
         */
        this.options = {};
        /**
         * Toggle readonly state of the editor.
         *
         * @memberof CodeEditorComponent
         */
        this.readOnly = false;
        this.valueChanged = new EventEmitter();
        this.loaded = new EventEmitter();
    }
    ngOnInit() { }
    ngOnDestroy() {
        this.subscriptions.forEach((subscription) => subscription.unsubscribe());
        this.subscriptions = [];
        if (this._editor) {
            this._editor.dispose();
            this._editor = null;
        }
        if (this._model) {
            this._model.dispose();
            this._model = null;
        }
    }
    ngOnChanges(changes) {
        if (changes.codeModel && !changes.codeModel.firstChange) {
            this.updateModel(changes.codeModel.currentValue);
        }
        if (changes.readOnly && !changes.readOnly.firstChange) {
            if (this._editor) {
                this._editor.updateOptions({
                    readOnly: changes.readOnly.currentValue,
                });
            }
        }
        if (changes.theme && !changes.theme.firstChange) {
            monaco.editor.setTheme(changes.theme.currentValue);
        }
    }
    onResize() {
        if (this._editor) {
            this._editor.layout();
        }
    }
    ngAfterViewInit() {
        return __awaiter(this, void 0, void 0, function* () {
            yield this.editorService.loadEditor();
            this.setupEditor();
            this.loaded.emit();
        });
    }
    setupEditor() {
        const domElement = this.editorContent.nativeElement;
        const settings = Object.assign({ value: '', language: 'text', uri: 'code' }, this.codeModel);
        this._model = monaco.editor.createModel(settings.value, settings.language, monaco.Uri.file(settings.uri));
        const options = Object.assign({}, this.defaultOptions, this.options, {
            readOnly: this.readOnly,
            theme: this.theme,
            model: this._model,
        });
        this._editor = monaco.editor.create(domElement, options);
        this._model.onDidChangeContent((e) => {
            const newValue = this._model.getValue();
            if (this.codeModel) {
                this.codeModel.value = newValue;
            }
            this.valueChanged.emit(newValue);
        });
        this.setupDependencies(this.codeModel);
    }
    setupDependencies(model) {
        if (!model) {
            return;
        }
        const { language } = model;
        if (language) {
            const lang = language.toLowerCase();
            switch (lang) {
                case 'typescript':
                    if (model.dependencies) {
                        this.editorService.loadTypings(model.dependencies);
                    }
                    break;
                case 'javascript':
                    if (model.dependencies) {
                        this.editorService.loadTypings(model.dependencies);
                    }
                    break;
                case 'json':
                    if (model.schemas) {
                        this.jsonDefaults.addSchemas(model.uri, model.schemas);
                    }
                    break;
                default:
                    break;
            }
        }
    }
    setEditorValue(value) {
        // Fix for value change while dispose in process.
        setTimeout(() => {
            if (this._model) {
                this._model.setValue(value);
            }
        });
    }
    updateModel(model) {
        if (model) {
            this.setEditorValue(model.value);
            if (this._model && typeof monaco !== undefined) {
                monaco.editor.setModelLanguage(this._model, model.language);
            }
            this.setupDependencies(model);
        }
    }
};
CodeEditorComponent.ctorParameters = () => [
    { type: CodeEditorService },
    { type: TypescriptDefaultsService },
    { type: JavascriptDefaultsService },
    { type: JsonDefaultsService }
];
__decorate([
    ViewChild('editor', { static: true }),
    __metadata("design:type", ElementRef)
], CodeEditorComponent.prototype, "editorContent", void 0);
__decorate([
    Input(),
    __metadata("design:type", Object)
], CodeEditorComponent.prototype, "codeModel", void 0);
__decorate([
    Input(),
    __metadata("design:type", Object)
], CodeEditorComponent.prototype, "theme", void 0);
__decorate([
    Input(),
    __metadata("design:type", Object)
], CodeEditorComponent.prototype, "options", void 0);
__decorate([
    Input(),
    __metadata("design:type", Object)
], CodeEditorComponent.prototype, "readOnly", void 0);
__decorate([
    Output(),
    __metadata("design:type", Object)
], CodeEditorComponent.prototype, "valueChanged", void 0);
__decorate([
    Output(),
    __metadata("design:type", Object)
], CodeEditorComponent.prototype, "loaded", void 0);
__decorate([
    HostListener('window:resize'),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", []),
    __metadata("design:returntype", void 0)
], CodeEditorComponent.prototype, "onResize", null);
CodeEditorComponent = __decorate([
    Component({
        selector: 'ngs-code-editor',
        template: "<div id=\"editor\" #editor class=\"monaco-editor editor\"></div>\n",
        changeDetection: ChangeDetectionStrategy.OnPush,
        encapsulation: ViewEncapsulation.None,
        // tslint:disable-next-line
        host: { class: 'ngs-code-editor' },
        styles: [".editor{width:100%;height:inherit;min-height:200px}"]
    }),
    __metadata("design:paramtypes", [CodeEditorService,
        TypescriptDefaultsService,
        JavascriptDefaultsService,
        JsonDefaultsService])
], CodeEditorComponent);
export { CodeEditorComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29kZS1lZGl0b3IuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQG5nc3RhY2svY29kZS1lZGl0b3IvIiwic291cmNlcyI6WyJsaWIvY29kZS1lZGl0b3IvY29kZS1lZGl0b3IuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQ0wsU0FBUyxFQUNULHVCQUF1QixFQUN2QixpQkFBaUIsRUFJakIsU0FBUyxFQUNULFVBQVUsRUFDVixLQUFLLEVBQ0wsTUFBTSxFQUNOLFlBQVksRUFHWixZQUFZLEdBQ2IsTUFBTSxlQUFlLENBQUM7QUFFdkIsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0saUNBQWlDLENBQUM7QUFDcEUsT0FBTyxFQUFFLHlCQUF5QixFQUFFLE1BQU0seUNBQXlDLENBQUM7QUFDcEYsT0FBTyxFQUFFLHlCQUF5QixFQUFFLE1BQU0seUNBQXlDLENBQUM7QUFDcEYsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sbUNBQW1DLENBQUM7QUFjeEUsSUFBYSxtQkFBbUIsR0FBaEMsTUFBYSxtQkFBbUI7SUFvRTlCLFlBQ1UsYUFBZ0MsRUFDaEMsa0JBQTZDLEVBQzdDLGtCQUE2QyxFQUM3QyxZQUFpQztRQUhqQyxrQkFBYSxHQUFiLGFBQWEsQ0FBbUI7UUFDaEMsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUEyQjtRQUM3Qyx1QkFBa0IsR0FBbEIsa0JBQWtCLENBQTJCO1FBQzdDLGlCQUFZLEdBQVosWUFBWSxDQUFxQjtRQXBFM0MsdUJBQXVCO1FBRWYsbUJBQWMsR0FBRztZQUN2QixXQUFXLEVBQUUsSUFBSTtZQUNqQixXQUFXLEVBQUUsS0FBSztZQUNsQixPQUFPLEVBQUU7Z0JBQ1AsT0FBTyxFQUFFLEtBQUs7YUFDZjtTQUNGLENBQUM7UUFFTSxrQkFBYSxHQUFtQixFQUFFLENBQUM7UUFRM0MsV0FBVztRQUNYLHlCQUF5QjtRQUN6Qiw2QkFBNkI7UUFDN0IsdUJBQXVCO1FBQ3ZCLDhCQUE4QjtR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MUI7SUFEQyxLQUFLLEVBQUU7O3NEQUNhO0FBc0JyQjtJQURDLEtBQUssRUFBRTs7a0RBQ0s7QUFVYjtJQURDLEtBQUssRUFBRTs7b0RBQ0s7QUFRYjtJQURDLEtBQUssRUFBRTs7cURBQ1M7QUFHakI7SUFEQyxNQUFNLEVBQUU7O3lEQUNpQztBQUcxQztJQURDLE1BQU0sRUFBRTs7bURBQ21CO0FBNkM1QjtJQURDLFlBQVksQ0FBQyxlQUFlLENBQUM7Ozs7bURBSzdCO0FBbkhVLG1CQUFtQjtJQVQvQixTQUFTLENBQUM7UUFDVCxRQUFRLEVBQUUsaUJBQWlCO1FBQzNCLDhFQUEyQztRQUUzQyxlQUFlLEVBQUUsdUJBQXVCLENBQUMsTUFBTTtRQUMvQyxhQUFhLEVBQUUsaUJBQWlCLENBQUMsSUFBSTtRQUNyQywyQkFBMkI7UUFDM0IsSUFBSSxFQUFFLEVBQUUsS0FBSyxFQUFFLGlCQUFpQixFQUFFOztLQUNuQyxDQUFDO3FDQXNFeUIsaUJBQWlCO1FBQ1oseUJBQXlCO1FBQ3pCLHlCQUF5QjtRQUMvQixtQkFBbUI7R0F4RWhDLG1CQUFtQixDQStNL0I7U0EvTVksbUJBQW1CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQ29tcG9uZW50LFxuICBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneSxcbiAgVmlld0VuY2Fwc3VsYXRpb24sXG4gIE9uQ2hhbmdlcyxcbiAgT25EZXN0cm95LFxuICBBZnRlclZpZXdJbml0LFxuICBWaWV3Q2hpbGQsXG4gIEVsZW1lbnRSZWYsXG4gIElucHV0LFxuICBPdXRwdXQsXG4gIEV2ZW50RW1pdHRlcixcbiAgU2ltcGxlQ2hhbmdlcyxcbiAgT25Jbml0LFxuICBIb3N0TGlzdGVuZXIsXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBDb2RlRWRpdG9yU2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2VzL2NvZGUtZWRpdG9yLnNlcnZpY2UnO1xuaW1wb3J0IHsgVHlwZXNjcmlwdERlZmF1bHRzU2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2VzL3R5cGVzY3JpcHQtZGVmYXVsdHMuc2VydmljZSc7XG5pbXBvcnQgeyBKYXZhc2NyaXB0RGVmYXVsdHNTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvamF2YXNjcmlwdC1kZWZhdWx0cy5zZXJ2aWNlJztcbmltcG9ydCB7IEpzb25EZWZhdWx0c1NlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy9qc29uLWRlZmF1bHRzLnNlcnZpY2UnO1xuaW1wb3J0IHsgQ29kZU1vZGVsIH0gZnJvbSAnLi4vbW9kZWxzL2NvZGUubW9kZWwnO1xuXG5kZWNsYXJlIGNvbnN0IG1vbmFjbzogYW55O1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICduZ3MtY29kZS1lZGl0b3InLFxuICB0ZW1wbGF0ZVVybDogJy4vY29kZS1lZGl0b3IuY29tcG9uZW50Lmh0bWwnLFxuICBzdHlsZVVybHM6IFsnLi9jb2RlLWVkaXRvci5jb21wb25lbnQuY3NzJ10sXG4gIGNoYW5nZURldGVjdGlvbjogQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3kuT25QdXNoLFxuICBlbmNhcHN1bGF0aW9uOiBWaWV3RW5jYXBzdWxhdGlvbi5Ob25lLFxuICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmVcbiAgaG9zdDogeyBjbGFzczogJ25ncy1jb2RlLWVkaXRvcicgfSxcbn0pXG5leHBvcnQgY2xhc3MgQ29kZUVkaXRvckNvbXBvbmVudFxuICBpbXBsZW1lbnRzIE9uSW5pdCwgT25DaGFuZ2VzLCBPbkRlc3Ryb3ksIEFmdGVyVmlld0luaXQge1xuICBwcml2YXRlIF9lZGl0b3I6IGFueTtcbiAgcHJpdmF0ZSBfbW9kZWw6IGFueTtcbiAgLy8gcHJpdmF0ZSBfdmFsdWUgPSAnJztcblxuICBwcml2YXRlIGRlZmF1bHRPcHRpb25zID0ge1xuICAgIGxpbmVOdW1iZXJzOiB0cnVlLFxuICAgIGNvbnRleHRtZW51OiBmYWxzZSxcbiAgICBtaW5pbWFwOiB7XG4gICAgICBlbmFibGVkOiBmYWxzZSxcbiAgICB9LFxuICB9O1xuXG4gIHByaXZhdGUgc3Vic2NyaXB0aW9uczogU3Vic2NyaXB0aW9uW10gPSBbXTtcblxuICBAVmlld0NoaWxkKCdlZGl0b3InLCB7IHN0YXRpYzogdHJ1ZSB9KVxuICBlZGl0b3JDb250ZW50OiBFbGVtZW50UmVmO1xuXG4gIEBJbnB1dCgpXG4gIGNvZGVNb2RlbDogQ29kZU1vZGVsO1xuXG4gIC8vIEBJbnB1dCgpXG4gIC8vIHNldCB2YWx1ZSh2OiBzdHJpbmcpIHtcbiAgLy8gICBpZiAodiAhPT0gdGhpcy5fdmFsdWUpIHtcbiAgLy8gICAgIHRoaXMuX3ZhbHVlID0gdjtcbiAgLy8gICAgIHRoaXMuc2V0RWRpdG9yVmFsdWUodik7XG4gIC8vICAgICB0aGlzLnZhbHVlQ2hhbmdlZC5lbWl0KHYpO1xuICAvLyAgIH1cbiAgLy8gfVxuXG4gIC8vIGdldCB2YWx1ZSgpOiBzdHJpbmcge1xuICAvLyAgIHJldHVybiB0aGlzLl92YWx1ZTtcbiAgLy8gfVxuXG4gIC8qKlxuICAgKiBFZGl0b3IgdGhlbWUuIERlZmF1bHRzIHRvIGB2c2AuXG4gICAqXG4gICAqIEFsbG93ZWQgdmFsdWVzOiBgdnNgLCBgdnMtZGFya2Agb3IgYGhjLWJsYWNrYC5cbiAgICogQG1lbWJlcm9mIENvZGVFZGl0b3JDb21wb25lbnRcbiAgICovXG4gIEBJbnB1dCgpXG4gIHRoZW1lID0gJ3ZzJztcblxuICAvKipcbiAgICogRWRpdG9yIG9wdGlvbnMuXG4gICAqXG4gICAqIFNlZSBodHRwczovL21pY3Jvc29mdC5naXRodWIuaW8vbW9uYWNvLWVkaXRvci9hcGkvaW50ZXJmYWNlcy9tb25hY28uZWRpdG9yLmllZGl0b3Jjb25zdHJ1Y3Rpb25vcHRpb25zLmh0bWwgZm9yIG1vcmUgZGV0YWlscy5cbiAgICpcbiAgICogQG1lbWJlcm9mIENvZGVFZGl0b3JDb21wb25lbnRcbiAgICovXG4gIEBJbnB1dCgpXG4gIG9wdGlvbnMgPSB7fTtcblxuICAvKipcbiAgICogVG9nZ2xlIHJlYWRvbmx5IHN0YXRlIG9mIHRoZSBlZGl0b3IuXG4gICAqXG4gICAqIEBtZW1iZXJvZiBDb2RlRWRpdG9yQ29tcG9uZW50XG4gICAqL1xuICBASW5wdXQoKVxuICByZWFkT25seSA9IGZhbHNlO1xuXG4gIEBPdXRwdXQoKVxuICB2YWx1ZUNoYW5nZWQgPSBuZXcgRXZlbnRFbWl0dGVyPHN0cmluZz4oKTtcblxuICBAT3V0cHV0KClcbiAgbG9hZGVkID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgZWRpdG9yU2VydmljZTogQ29kZUVkaXRvclNlcnZpY2UsXG4gICAgcHJpdmF0ZSB0eXBlc2NyaXB0RGVmYXVsdHM6IFR5cGVzY3JpcHREZWZhdWx0c1NlcnZpY2UsXG4gICAgcHJpdmF0ZSBqYXZhc2NyaXB0RGVmYXVsdHM6IEphdmFzY3JpcHREZWZhdWx0c1NlcnZpY2UsXG4gICAgcHJpdmF0ZSBqc29uRGVmYXVsdHM6IEpzb25EZWZhdWx0c1NlcnZpY2VcbiAgKSB7fVxuXG4gIG5nT25Jbml0KCkge31cblxuICBuZ09uRGVzdHJveSgpIHtcbiAgICB0aGlzLnN1YnNjcmlwdGlvbnMuZm9yRWFjaCgoc3Vic2NyaXB0aW9uKSA9PiBzdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKSk7XG4gICAgdGhpcy5zdWJzY3JpcHRpb25zID0gW107XG5cbiAgICBpZiAodGhpcy5fZWRpdG9yKSB7XG4gICAgICB0aGlzLl9lZGl0b3IuZGlzcG9zZSgpO1xuICAgICAgdGhpcy5fZWRpdG9yID0gbnVsbDtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5fbW9kZWwpIHtcbiAgICAgIHRoaXMuX21vZGVsLmRpc3Bvc2UoKTtcbiAgICAgIHRoaXMuX21vZGVsID0gbnVsbDtcbiAgICB9XG4gIH1cblxuICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKSB7XG4gICAgaWYgKGNoYW5nZXMuY29kZU1vZGVsICYmICFjaGFuZ2VzLmNvZGVNb2RlbC5maXJzdENoYW5nZSkge1xuICAgICAgdGhpcy51cGRhdGVNb2RlbChjaGFuZ2VzLmNvZGVNb2RlbC5jdXJyZW50VmFsdWUpO1xuICAgIH1cblxuICAgIGlmIChjaGFuZ2VzLnJlYWRPbmx5ICYmICFjaGFuZ2VzLnJlYWRPbmx5LmZpcnN0Q2hhbmdlKSB7XG4gICAgICBpZiAodGhpcy5fZWRpdG9yKSB7XG4gICAgICAgIHRoaXMuX2VkaXRvci51cGRhdGVPcHRpb25zKHtcbiAgICAgICAgICByZWFkT25seTogY2hhbmdlcy5yZWFkT25seS5jdXJyZW50VmFsdWUsXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChjaGFuZ2VzLnRoZW1lICYmICFjaGFuZ2VzLnRoZW1lLmZpcnN0Q2hhbmdlKSB7XG4gICAgICBtb25hY28uZWRpdG9yLnNldFRoZW1lKGNoYW5nZXMudGhlbWUuY3VycmVudFZhbHVlKTtcbiAgICB9XG4gIH1cblxuICBASG9zdExpc3RlbmVyKCd3aW5kb3c6cmVzaXplJylcbiAgb25SZXNpemUoKSB7XG4gICAgaWYgKHRoaXMuX2VkaXRvcikge1xuICAgICAgdGhpcy5fZWRpdG9yLmxheW91dCgpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIG5nQWZ0ZXJWaWV3SW5pdCgpIHtcbiAgICBhd2FpdCB0aGlzLmVkaXRvclNlcnZpY2UubG9hZEVkaXRvcigpO1xuICAgIHRoaXMuc2V0dXBFZGl0b3IoKTtcbiAgICB0aGlzLmxvYWRlZC5lbWl0KCk7XG4gIH1cblxuICBwcml2YXRlIHNldHVwRWRpdG9yKCkge1xuICAgIGNvbnN0IGRvbUVsZW1lbnQ6IEhUTUxEaXZFbGVtZW50ID0gdGhpcy5lZGl0b3JDb250ZW50Lm5hdGl2ZUVsZW1lbnQ7XG4gICAgY29uc3Qgc2V0dGluZ3MgPSB7XG4gICAgICB2YWx1ZTogJycsXG4gICAgICBsYW5ndWFnZTogJ3RleHQnLFxuICAgICAgdXJpOiAnY29kZScsXG4gICAgICAuLi50aGlzLmNvZGVNb2RlbCxcbiAgICB9O1xuXG4gICAgdGhpcy5fbW9kZWwgPSBtb25hY28uZWRpdG9yLmNyZWF0ZU1vZGVsKFxuICAgICAgc2V0dGluZ3MudmFsdWUsXG4gICAgICBzZXR0aW5ncy5sYW5ndWFnZSxcbiAgICAgIG1vbmFjby5VcmkuZmlsZShzZXR0aW5ncy51cmkpXG4gICAgKTtcblxuICAgIGNvbnN0IG9wdGlvbnMgPSBPYmplY3QuYXNzaWduKHt9LCB0aGlzLmRlZmF1bHRPcHRpb25zLCB0aGlzLm9wdGlvbnMsIHtcbiAgICAgIHJlYWRPbmx5OiB0aGlzLnJlYWRPbmx5LFxuICAgICAgdGhlbWU6IHRoaXMudGhlbWUsXG4gICAgICBtb2RlbDogdGhpcy5fbW9kZWwsXG4gICAgfSk7XG5cbiAgICB0aGlzLl9lZGl0b3IgPSBtb25hY28uZWRpdG9yLmNyZWF0ZShkb21FbGVtZW50LCBvcHRpb25zKTtcblxuICAgIHRoaXMuX21vZGVsLm9uRGlkQ2hhbmdlQ29udGVudCgoZSkgPT4ge1xuICAgICAgY29uc3QgbmV3VmFsdWUgPSB0aGlzLl9tb2RlbC5nZXRWYWx1ZSgpO1xuICAgICAgaWYgKHRoaXMuY29kZU1vZGVsKSB7XG4gICAgICAgIHRoaXMuY29kZU1vZGVsLnZhbHVlID0gbmV3VmFsdWU7XG4gICAgICB9XG4gICAgICB0aGlzLnZhbHVlQ2hhbmdlZC5lbWl0KG5ld1ZhbHVlKTtcbiAgICB9KTtcblxuICAgIHRoaXMuc2V0dXBEZXBlbmRlbmNpZXModGhpcy5jb2RlTW9kZWwpO1xuICB9XG5cbiAgcHJpdmF0ZSBzZXR1cERlcGVuZGVuY2llcyhtb2RlbDogQ29kZU1vZGVsKSB7XG4gICAgaWYgKCFtb2RlbCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IHsgbGFuZ3VhZ2UgfSA9IG1vZGVsO1xuXG4gICAgaWYgKGxhbmd1YWdlKSB7XG4gICAgICBjb25zdCBsYW5nID0gbGFuZ3VhZ2UudG9Mb3dlckNhc2UoKTtcblxuICAgICAgc3dpdGNoIChsYW5nKSB7XG4gICAgICAgIGNhc2UgJ3R5cGVzY3JpcHQnOlxuICAgICAgICAgIGlmIChtb2RlbC5kZXBlbmRlbmNpZXMpIHtcbiAgICAgICAgICAgIHRoaXMuZWRpdG9yU2VydmljZS5sb2FkVHlwaW5ncyhtb2RlbC5kZXBlbmRlbmNpZXMpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSAnamF2YXNjcmlwdCc6XG4gICAgICAgICAgaWYgKG1vZGVsLmRlcGVuZGVuY2llcykge1xuICAgICAgICAgICAgdGhpcy5lZGl0b3JTZXJ2aWNlLmxvYWRUeXBpbmdzKG1vZGVsLmRlcGVuZGVuY2llcyk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlICdqc29uJzpcbiAgICAgICAgICBpZiAobW9kZWwuc2NoZW1hcykge1xuICAgICAgICAgICAgdGhpcy5qc29uRGVmYXVsdHMuYWRkU2NoZW1hcyhtb2RlbC51cmksIG1vZGVsLnNjaGVtYXMpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBicmVhaztcbiAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHNldEVkaXRvclZhbHVlKHZhbHVlOiBhbnkpOiB2b2lkIHtcbiAgICAvLyBGaXggZm9yIHZhbHVlIGNoYW5nZSB3aGlsZSBkaXNwb3NlIGluIHByb2Nlc3MuXG4gICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICBpZiAodGhpcy5fbW9kZWwpIHtcbiAgICAgICAgdGhpcy5fbW9kZWwuc2V0VmFsdWUodmFsdWUpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSB1cGRhdGVNb2RlbChtb2RlbDogQ29kZU1vZGVsKSB7XG4gICAgaWYgKG1vZGVsKSB7XG4gICAgICB0aGlzLnNldEVkaXRvclZhbHVlKG1vZGVsLnZhbHVlKTtcbiAgICAgIGlmICh0aGlzLl9tb2RlbCAmJiB0eXBlb2YgbW9uYWNvICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgbW9uYWNvLmVkaXRvci5zZXRNb2RlbExhbmd1YWdlKHRoaXMuX21vZGVsLCBtb2RlbC5sYW5ndWFnZSk7XG4gICAgICB9XG4gICAgICB0aGlzLnNldHVwRGVwZW5kZW5jaWVzKG1vZGVsKTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==